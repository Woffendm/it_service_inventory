
<%= stylesheet_link_tag 'scrum2b', :plugin => 'scrum2b' %>



<% all_issue_statuses = IssueStatus.sorted %>
<% custom_fields = IssueCustomField.where(:field_format => "list").order(:name) %>
<% board_columns = [] %>

<% board_columns = @settings["board_columns"].to_a %>
<% board_columns.sort! { |a, b| a.second["position"].to_f <=> b.second["position"].to_f} %>
<% using_version = @settings["use_version_for_sprint"] == "true" %>





  <!-- Commented out because this view is rendered in redmine's /settings/plugin.html.erb, and the div starts there 
    <div class="box tabular">
  -->

      <div class="section_header">
        <h3>
          Sprint Sorting
        </h3>
      </div>


      <p>
        <%= content_tag(:label, "Use project version")%>
        <%= radio_button_tag("settings[use_version_for_sprint]", "true", using_version) %>
      </p>
      <p>
        <%= content_tag(:label, "Use custom field")%>
        <%= radio_button_tag("settings[use_version_for_sprint]", "false", !using_version) %>
      </p>

      <p id="custom_field_select" class='<%= "hidden" if using_version %>'>
        <%= content_tag(:label, "Sprint custom field")%>
        <%= select_tag("settings[custom_field_id]", options_from_collection_for_select(custom_fields, :id, :name, {:selected => @settings["custom_field_id"]})) %>
      </p>

    </div>


    <div class="box tabular">
      <div class="section_header">
        <h3>
          Board Columns 
          <%= button_tag("New Column", :type => :button, :id => "new_column_button") %>  
        </h3>
      </div>


      <div id="new_columns" class="hidden">
      </div>


      <% board_columns.each_with_index do |board_column, index| %>
        <div class="<%= 'subsection' unless board_column == board_columns.last %>"
        id="column_<%= index %>" >
          <p>
            <%= button_tag("Delete", :type => :button, :class => "delete_column contextual", :parent_id => "#column_#{ index }") %>  

            <%= content_tag(:label, "Name" )%>
            <%= text_field_tag("settings[board_columns][#{board_column.first}][name]", board_column.last["name"]) %>

            <br/>

            <%= content_tag(:label, "Position" )%>
            <%= select_tag("settings[board_columns][#{board_column.first}][position]", options_for_select(1..board_columns.length, :selected => (index + 1))) %>

            <br/>

            <%= content_tag(:label, "Statuses" )%>
            <% all_issue_statuses.each do |status| %>
              <span>
                <%= check_box_tag "settings[board_columns][#{board_column.first}][statuses][#{status.id}]", status.name, board_column.last["statuses"] && board_column.last["statuses"].include?(status.id.to_s) %>
                <%= status.name %>
              </span>
            <% end %>
          </p>
        </div>
      <% end %>



      <div id="template" class="hidden">
        <div class="subsection" id="column_-1">
          <p>
            <%= button_tag("Delete", :type => :button, :class => "delete_column contextual", :parent_id => "#column_-1", :id => "delete_-1") %>  

            <%= content_tag(:label, "Name" )%>
            <%= text_field_tag("settings[board_columns][-1][name]") %>

            <br/>

            <%= content_tag(:label, "Position" )%>
            <%= select_tag("settings[board_columns][-1][position]", options_for_select(1..(@settings["board_columns"].length + 1))) %>

            <br/>

            <%= content_tag(:label, "Statuses" )%>
            <% all_issue_statuses.each do |status| %>
              <%= check_box_tag "settings[board_columns][-1][statuses][#{status.id}]" %>
              <%= status.name %>
            <% end %>
          </p>
        </div>
      </div>


  <!-- Commented out because this view is rendered in redmine's /settings/plugin.html.erb, and the div ends there 
    </div>
  -->















<!-- confirmation popup -->
<script type="text/javascript">
  $(document).ready(function(){  
    
    
    var confirm_msg = "<%= l(:text_are_you_sure) %>";
    var new_columns = $("#new_columns");
    var delete_column = $(".delete_column");
    var template = $("#template");
    var custom_field_select = $("#custom_field_select");
    var issue_ids = <%= all_issue_statuses.pluck(:id) %>;
    var new_column_id = <%= @settings["board_columns"].to_a.map!{ |p| p.first.to_f }.sort!.last.to_i + 1 %>;


    $("input[type='submit']").click(function(e){
      if (!confirm(confirm_msg)) {
        e.preventDefault();
        return;
      }
      template.remove();
    });


    $("#new_column_button").click(function(e) {
      new_columns.show();
      new_columns.prepend(template.html());
      $("#column_-1").attr("id", "column_" + new_column_id);
      $("#delete_-1").attr("parent_id", "#column_" + new_column_id).attr("id", "delete_" + new_column_id);
      $("#settings_board_columns_-1_name").attr("name", "settings[board_columns][" + new_column_id + "][name]").attr("id", "settings_board_columns_" + new_column_id + "_name");
      $("#settings_board_columns_-1_position").attr("name", "settings[board_columns][" + new_column_id + "][position]").attr("id", "settings_board_columns_" + new_column_id + "_position");
      $.each(issue_ids, function(index, value) {
        $("#settings_board_columns_-1_statuses_" + value).attr("name", "settings[board_columns][" + new_column_id + "][statuses][" + value + "]").attr("id", "settings_board_columns_" + new_column_id + "_statuses_" + value);
      });
      new_column_id += 1;
      delete_column = $(".delete_column");
    });


    delete_column.live("click", function(e) {
      $($(this).attr("parent_id")).remove();
    });
    
    
    $("#settings_use_version_for_sprint_false").click(function(e) {
      custom_field_select.show();
    });
    
    
    $("#settings_use_version_for_sprint_true").click(function(e) {
      custom_field_select.hide();
    });
    
    
  });
</script>






